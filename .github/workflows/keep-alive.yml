name: ClawCloud è‡ªåŠ¨ç™»å½•ä¿æ´»

on:
  schedule:
    - cron: '0 7 */5 * *'  # UTC 7:00ï¼Œæ¯5å¤©è¿è¡Œ
  workflow_dispatch:

jobs:
  # === JOB 1: æ™ºèƒ½æ£€æµ‹è´¦å·æ•°é‡ ===
  check_accounts:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        env:
          # è´¦å· 1 (åŸºç¡€æ— åç¼€)
          U1: ${{ secrets.GH_USERNAME }}
          # è´¦å· 2-6 (å¸¦åç¼€)
          U2: ${{ secrets.GH_USERNAME_2 }}
          U3: ${{ secrets.GH_USERNAME_3 }}
          U4: ${{ secrets.GH_USERNAME_4 }}
          U5: ${{ secrets.GH_USERNAME_5 }}
          U6: ${{ secrets.GH_USERNAME_6 }}
        run: |
          echo "ğŸ” æ­£åœ¨æ™ºèƒ½æ£€æµ‹å·²é…ç½®çš„è´¦å·..."
          ids="[]"
          
          # === ä¿®å¤ç‚¹ï¼šæ·»åŠ  -c å‚æ•°å¼ºåˆ¶è¾“å‡ºå•è¡Œ JSON ===
          
          if [ -n "$U1" ]; then
            ids=$(echo $ids | jq -c '. + [1]')
            echo "âœ… å‘ç°è´¦å· 1"
          fi
          
          if [ -n "$U2" ]; then
            ids=$(echo $ids | jq -c '. + [2]')
            echo "âœ… å‘ç°è´¦å· 2"
          fi
          
          if [ -n "$U3" ]; then
            ids=$(echo $ids | jq -c '. + [3]')
            echo "âœ… å‘ç°è´¦å· 3"
          fi
          
          if [ -n "$U4" ]; then
            ids=$(echo $ids | jq -c '. + [4]')
            echo "âœ… å‘ç°è´¦å· 4"
          fi
          
          if [ -n "$U5" ]; then
            ids=$(echo $ids | jq -c '. + [5]')
            echo "âœ… å‘ç°è´¦å· 5"
          fi
          
          if [ -n "$U6" ]; then
            ids=$(echo $ids | jq -c '. + [6]')
            echo "âœ… å‘ç°è´¦å· 6"
          fi

          # è¾“å‡ºæœ€ç»ˆçŸ©é˜µ
          echo "ğŸ“Š æœ€ç»ˆè¿è¡ŒçŸ©é˜µ: $ids"
          echo "matrix=$ids" >> $GITHUB_OUTPUT

  # === JOB 2: å¹¶è¡Œæ‰§è¡Œç™»å½•ä»»åŠ¡ ===
  auto-login:
    needs: check_accounts
    if: ${{ needs.check_accounts.outputs.matrix != '[]' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    strategy:
      fail-fast: false
      matrix:
        account_id: ${{ fromJson(needs.check_accounts.outputs.matrix) }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install playwright requests pynacl
          playwright install chromium
          playwright install-deps

      - name: è¿è¡Œè‡ªåŠ¨ç™»å½• (è´¦å· ${{ matrix.account_id }})
        env:
          # === 1. å¯¼å…¥æ‰€æœ‰åŠ¨æ€å˜é‡ ===
          # è´¦å· 1
          GH_USERNAME_1: ${{ secrets.GH_USERNAME }}
          GH_PASSWORD_1: ${{ secrets.GH_PASSWORD }}
          GH_SESSION_1: ${{ secrets.GH_SESSION }}
          
          # è´¦å· 2
          GH_USERNAME_2: ${{ secrets.GH_USERNAME_2 }}
          GH_PASSWORD_2: ${{ secrets.GH_PASSWORD_2 }}
          GH_SESSION_2: ${{ secrets.GH_SESSION_2 }}
          
          # è´¦å· 3
          GH_USERNAME_3: ${{ secrets.GH_USERNAME_3 }}
          GH_PASSWORD_3: ${{ secrets.GH_PASSWORD_3 }}
          GH_SESSION_3: ${{ secrets.GH_SESSION_3 }}
          
          # è´¦å· 4
          GH_USERNAME_4: ${{ secrets.GH_USERNAME_4 }}
          GH_PASSWORD_4: ${{ secrets.GH_PASSWORD_4 }}
          GH_SESSION_4: ${{ secrets.GH_SESSION_4 }}
          
          # è´¦å· 5
          GH_USERNAME_5: ${{ secrets.GH_USERNAME_5 }}
          GH_PASSWORD_5: ${{ secrets.GH_PASSWORD_5 }}
          GH_SESSION_5: ${{ secrets.GH_SESSION_5 }}

          # è´¦å· 6
          GH_USERNAME_6: ${{ secrets.GH_USERNAME_6 }}
          GH_PASSWORD_6: ${{ secrets.GH_PASSWORD_6 }}
          GH_SESSION_6: ${{ secrets.GH_SESSION_6 }}
          
          # === 2. å¯¼å…¥é€šç”¨å˜é‡ ===
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
          
        run: |
          ID="${{ matrix.account_id }}"
          echo "ğŸš€ æ­£åœ¨å¯åŠ¨è´¦å· $ID çš„ä»»åŠ¡..."

          # === æ ¸å¿ƒé€»è¾‘ï¼šæ ¹æ® ID è‡ªåŠ¨æŠ“å–å¯¹åº”çš„å˜é‡ ===
          
          if [ "$ID" == "1" ]; then
            # è´¦å· 1 ç‰¹æ®Šå¤„ç†ï¼ˆæ— åç¼€ï¼‰
            export GH_USERNAME="$GH_USERNAME_1"
            export GH_PASSWORD="$GH_PASSWORD_1"
            export GH_SESSION="$GH_SESSION_1"
            export SESSION_SECRET_KEY="GH_SESSION"
          else
            # è´¦å· 2+ ä½¿ç”¨é—´æ¥å¼•ç”¨
            u_var="GH_USERNAME_$ID"
            p_var="GH_PASSWORD_$ID"
            s_var="GH_SESSION_$ID"
            
            export GH_USERNAME="${!u_var}"
            export GH_PASSWORD="${!p_var}"
            export GH_SESSION="${!s_var}"
            export SESSION_SECRET_KEY="GH_SESSION_$ID"
          fi

          if [ -z "$GH_USERNAME" ]; then
            echo "âŒ ä¸¥é‡é”™è¯¯ï¼šæ— æ³•è¯»å–åˆ°è´¦å· $ID çš„ç”¨æˆ·åï¼Œè¯·æ£€æŸ¥ Secrets é…ç½®ï¼"
            exit 1
          fi

          python scripts/auto_login.py
